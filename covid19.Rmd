---
title: "Covid-19"
author: "Siming Yan"
date:   "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: spacelab
    keep_md: true
    toc: yes
    toc_float: true
    highlight: haddock
    
---

<html>
<style> 
div.bgm { background-color:#e6fff0; border-radius: 7px; padding: 10px;} 
.ans {
  color: purple;
  font-weight: bold;
}
#main { 
    color: #2cb061; 
}
</style>

<div class = "bgm">

<ul id="main">


```{r setup, echo=FALSE, cache=FALSE, include = F}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
knitr::opts_chunk$set(
	fig.width = 7,
	message = FALSE,
	warning = FALSE,
	cache = TRUE,
	comment = NA,
	dpi = 300,
	prompt = FALSE,
	tidy = TRUE
)
opts_knit$set(width=75)
# knitr::opts_chunk$set()
options(digits=5)
options(scipen=5)
knitr::opts_chunk$set(warning = F, message=F)

```

### set
 
```{r setup2, include=FALSE}

library(knitr)
library(dplyr)
library(tidyr)
library(lubridate)
library(scales)
library(stargazer)
library(tidyverse)
# library(car)
library(formatR)
# library(plm)
# library(lfe)
library(data.table)
# library(mlogit)
# library(lmtest) #for coeftest() and bptest().
# library(broom) #for glance() and tidy()
# library(RCurl)# For the robust SE method 1
# library(sandwich)
library(texreg) 
library(mice) #check NA
# library(MatchIt)
library(ggthemes)
library(RColorBrewer)
library(readxl)
library(openxlsx)
library(zoo)
library(pinyin)
library(ggthemr)
library(kableExtra)
library(plotly)

library(gt)
library(DataExplorer)
library(lfe) #felm
```

```{r functions, warning=F, message=F, include = F}
kbt <- function(...){
  knitr::kable(..., format.args = list(big.mark = ',', scientific = F)) %>%
    kableExtra::kable_styling(c("striped", "hover", "condensed"),
                               full_width = F,
                               position = "center",
                               row_label_position = "c") %>%
   row_spec(0, bold = T, color = "white", background = "#004d1f")
}

gpt <- function(...){
  ggplot2::ggplot(...) + 
    theme_minimal() +
    theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
      plot.subtitle = element_text(face = "italic", size = 12, hjust = 0.5), 
      axis.text.x = element_text(angle = 0, hjust = 0.5))
}

stg <- function(...){
  stargazer::stargazer(..., 
          type = "text",
          # style = "qje",
          # title = "daily_kwh ~ post:encouraged|customer_id + no.bill|0|customer_id",
          keep.stat = c("n", "ser"),
          digits = 5)
}

gpt_area <- function(in_data, in_x, in_y, in_times, heading, heading_x,heading_y){
  gpt(in_data) +
  # geom_point(aes(x = in_x, 
  #              y = in_times*in_y), 
  #          alpha = I(.8)) +
  # geom_line(aes(x = in_x, 
  #              y = in_times*in_y,
  #              group = 1)) +
  geom_bar(aes(x = in_x, 
               weight = in_y,
               alpha = I(.9))) +
  theme(axis.text.x = element_text(angle = 0, hjust = .6)) +
  geom_text(data = in_data,
            aes(x = in_x,
                y = in_y,
                label= in_y),
            size = 5, 
            vjust = -0.2) +
  labs(title  = heading,
       x = heading_x,
       y = heading_y) +
  theme(text = element_text(size = 22),
        plot.title = element_text(size = 25))
}

mod_stargazer <- function(output.file, ...) {
  output <- capture.output(stargazer(...))
  cat(paste(output, collapse = "\n"), "\n", file=output.file, append=F)
}

ggthemr('light',type = 'outer')

```




#--------------------------------------------

## 1. data_pp(16-19)


```{r}

library(coronavirus)
# run_app(virus)
# ggthemr('light',type = 'outer')
```


```{r}
covid <- coronavirus %>%
  filter(country == "China", type == "confirmed")
covid_sx <- covid %>% filter(province == "Shanxi")

```


```{r}
ggplot(covid) +
 aes(x = date, fill = country, colour = cases, group = country, weight = cases) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "RdGy") +
 scale_color_distiller(palette = "RdGy") 

```


#--------------------------------------------
## 2. covid plots

```{r}
covid <- covid %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))

confirm_plt <- aggregate(cases~month, covid, sum)

gpt(confirm_plt)+
  aes(x = month, y = cases)+
  geom_col()+
  geom_text(data = confirm_plt,
            aes(x = month,
                y =  cases,
                label= cases),
            vjust = -0.2)


gpt_china_covid_case <- gpt_area(confirm_plt, 
                                 confirm_plt$month, 
                                 confirm_plt$cases, 
                                 1, 
                                 "Exsisting cases in China Mainland", 
                                 "month", 
                                 "sum") + 
  scale_x_continuous(n.breaks = 7)

ggsave(filename = "../report/covid_china_case.png", plot = gpt_china_covid_case, width = 12)
# #--------------------------------------------

gpt_china_covid_case 
#   geom_point(data = pp_data, x = month, y)
```

#--------------------------------------------

```{r}
pp_yrm_s.complete_plt <- pp_data %>% group_by(month, as.factor(year)) %>% summarise(sum(complete)) %>% 
  rbind()

pt1 <- pp_yrm_s.complete_plt[pp_yrm_s.complete_plt$`as.factor(year)` == "20",]
pt1[7,] <- pt1[6,]
pt1[7,1] <- 7
pt1[7,3] <- 301.1704-53.964
plt1 <- cbind(confirm_plt, pt1)
plt1 <- plt1[,-1]


china_covid_el_gen <- gpt_area(plt1, 
                               confirm_plt$month, 
                               confirm_plt$cases, 
                               1, 
                               "Exsisting cases in China Mainland", 
                               "month", 
                               "sum") + 
  geom_point(aes(x = month, y = `sum(complete)` * 100), color = "red") +
  geom_line(aes(x = month, y = `sum(complete)` * 100), color = "purple") +
  geom_text(data = plt1,
            aes(x = month,
                y = `sum(complete)` * 100 ,
                label= `sum(complete)`),
            vjust = -0.2,
            size = 6) +
  scale_x_continuous(n.breaks = 7) 
#--------------------------------------------
china_covid_el_gen
ggsave(filename = "../report/covid_el-gen_china.png", plot = china_covid_el_gen, width = 12)

```

```{r}
covid_sx <- covid_sx %>% group_by(month) %>% summarise(sum(cases)) %>% cbind(pt1)
covid_sx <- covid_sx[,-3]

ggthemr('light',type = 'outer')

shanxi_covid_el_gen <- gpt_area(covid_sx, 
                                covid_sx$month, 
                                covid_sx$`sum(cases)`, 
                                1, 
                                "Exsisting cases in Shanxi Province", 
                                "month", 
                                "sum") + 
  geom_point(aes(x = month, y = `sum(complete)` ), color = "red") +
  geom_line(aes(x = month, y = `sum(complete)` ), color = "purple") +
  geom_text(data = covid_sx,
            aes(x = month,
                y = `sum(complete)` ,
                label= `sum(complete)`),
            vjust = -0.2,
            size = 5) +
  scale_x_continuous(n.breaks = 7) 
shanxi_covid_el_gen

#-------------------------------------------
ggsave(filename = "../report/covid_el-gen_shanxi.png", plot = shanxi_covid_el_gen, width = 12)
```





#--------------------------------------------

```{r}
# p1 <- ggplot(pp_yrm_s.complete_plt) +
#  aes(x = month, y = `sum(complete)`, colour = `as.factor(year)`) +
#  geom_line(size = .5L) +
#  scale_color_hue() +
#  theme_minimal() + 
#  scale_x_continuous(n.break = 12)
# p1 
```


```{r}
confirm_plt <- aggregate(cases~month, covid, sum)
plt2 <- merge(confirm_plt, pp_yrm_s.complete_plt, by = "month")

ggplot(plt2) +
 aes(x = month) +
 geom_line(aes(y = plt2$`sum(complete)`*915), 
     fill = plt2$`sum(complete)`, 
     colour = plt2$`as.factor(year)`, 
     group = plt2$`as.factor(year)`, size = 1L) +
 scale_fill_gradient() +
 scale_color_hue() +
 theme_minimal() +
  geom_bar(aes(x = month, weight = cases), alpha = I(.4))
```



#--------------------------------------------

## 3. big5

```{r}
pp_data$big_five %>% table
# 9594+2766 
# 0     1 
df_big5_year_comp <- pp_data %>% group_by(big_five, year, month) %>% summarise(mean.com = mean(complete),
                                                                               mean.cap = mean(capacity))

# df_big5_year_comp <- df_big5_year_comp[-c(1,6), ]
names(df_big5_year_comp)
df_big5_year_comp$yearmon <- as.yearmon(paste(df_big5_year_comp$year,df_big5_year_comp$month), "%y%m")


#--------------------------------------------


gpt(df_big5_year_comp %>% filter(year == 20))+geom_line(aes(x = yearmon, y = `mean(complete)`, color = big_five))
```
#--------------------------------------------
#### 3.5 plots of big5 

```{r}
ggthemr('light',type = 'outer')

comp_big5_plot <- gpt(compar_big5) + aes(x = big5) +
  geom_bar(aes(weights = avg_com, fill = big5)) +
  geom_text(data = compar_big5,
            aes(x = big5,
                y = avg_com %>% round(3),
                label= avg_com),
            size = 9,
            hjust = .7) +
  labs(fill = "Owner Type") +
  theme(text = element_text(size = 22),
        plot.title = element_text(size = 25))+
  xlab("") +
  ylab("") +
  scale_fill_brewer(palette = "Set3") +
  coord_flip()
comp_big5_plot
#--------------------------------------------


comp_big5_plot3 <- gpt(compar_big5) + aes(x = big5) +
  geom_bar(aes(weights = avg_cap, fill = big5)) +
  geom_text(data = compar_big5,
            aes(x = big5,
                y = avg_cap %>% round(3),
                label= avg_cap),
            size = 9,
            hjust = .7) +
  labs(fill = "Owner Type") +
  theme(text = element_text(size = 22),
        plot.title = element_text(size = 25))+
  xlab("") +
  ylab("") +
  scale_fill_brewer(palette = "Set3") +
  coord_flip()
comp_big5_plot3

#--------------------------------------------
compar_big5$n2 <- compar_big5$n/sum(compar_big5$n) %>% round(3)
# cumsum(compar_big5$n2) - 0.5*compar_big5$n2

comp_big5_share <-
  gpt(compar_big5) +
  geom_bar(aes(x = "", weight = n2, fill = big5), width = 1, position = "identity") +
  geom_text(aes(x = "", y = cumsum(n2) - 0.5*n2,
                label= n),
            size = 9,
            vjust = 1) +
  coord_polar("y", start=0) +
  theme_void() + 
  # average_completed per month
  labs(fill = "Owner Type",
       title = "Comparation of big-five and non-big-five owned power plant",
       subtitle = "Average Completed per month") +
  scale_fill_brewer(palette = "Set3") +
  theme(text = element_text(size = 22),
        plot.title = element_text(size = 25),
        legend.position = "none")
comp_big5_share

#--------------------------------------------
#--------------------------------------------

ggsave("../report/comp_big5_share.png", plot = comp_big5_share, width = 12)
ggsave("../report/comp_big5_plot.png", plot = comp_big5_plot, width = 12)
```


```{r}
#--------------------------------------------

  ggsave("../report/comp_big5_plot.png", plot = comp_big5_plot, width = 12)
```


#--------------------------------------------

### 4. causal inference

#--------------------------------------------
```{r}

```

```{r}
pp_data %>% names

# pp_data_dummy <- fastDummies::dummy_cols(pp_data, select_columns = c("month", "year", "area3"))
# pp_data$yearmonth <- as.yearmon(paste(pp_data$year, pp_data$month), "%y%m")

comp.mean.area3 = (pp_data %>% group_by(yearmonth, area3) %>% summarise(mean(complete)) %>% ungroup())
pp_data_test <- merge(comp.mean.area3, pp_data, by = c("yearmonth", "area3"))
names(pp_data_test)[3] = "mean.com.area3"
#--------------------------------------------
 
pp_data_dummy <- select(pp_data_test, c(-generated_el, -time, -op_time, -area, -plant, -parent_company))

pp_data_dummy$spr_festival <- "0"


pp_data_dummy <- mutate(pp_data_dummy, spr_festival = ifelse(month == 1 & year != 18 | 
                                                               month ==2 & year == 18, "1", "0"))
pp_data <- mutate(pp_data, spr_festival = ifelse(month == 1 & year != 18 | 
                                                               month ==2 & year == 18, "1", "0"))
# pp_data_dummy %>% filter(year == 18) %>% group_by(month) %>% slice(5)

pp_data_dummy <- mutate(pp_data_dummy, bf_covid = ifelse(year != 20 | year == 20 & month == 1, "1", "0"))
pp_data <- mutate(pp_data, bf_covid = ifelse(year != 20 | year == 20 & month == 1, "1", "0"))

# pp_data <- mutate(pp_data, bf_covid = ifelse())
#--------------------------------------------
```

#--------------------------------------------
## 4.01 creat comparation data

```{r}
pp_data_dummy <- select(pp_data_dummy, c(-month, -year))
pp_data_dummy %>% names
pp_data_dummy$complete = pp_data_dummy$complete*100
# which(is.na(pp_data_dummy) == T)
# which(pp_data_dummy$area3 == "NA")
# pp_data_dummy <- pp_data_dummy[-which(pp_data_dummy$area3 == "NA"), ]
pp_data_dummy2 <- pp_data_dummy %>% filter(Hydro != 1)
#--------------------------------------------

which(pp_data_dummy2$big_five == 1) %>% length

pp_data_dummy2$complete[which(pp_data_dummy2$big_five == 1)] %>% sum()
# 2664.8/2766
# 0.96341
pp_data_dummy2$complete[which(pp_data_dummy2$big_five != 1)] %>% sum()
# 0.59136
# which(pp_data_dummy2$big_five != 1) %>% length

# exclude hydro
# 5402/9563
# 0.56489
#--------------------------------------------

pp_data_dummy2$capacity[which(pp_data_dummy2$big_five == 1)] %>% sum()
# 82218/2766
# 29.725
pp_data_dummy2$capacity[which(pp_data_dummy2$big_five != 1)] %>% sum()

# 201875/9563
# 21.11

# 189912/9563
# 19.859
#--------------------------------------------

compar_big5 <- data.frame(big5 = c("1","0") %>% as.factor(), 
                          avg_com = c(0.96341, 0.59136), 
                          avg_cap = c(29.725, 21.11), 
                          avg_com.nHydro = c(0.96341, 0.56489), 
                          avg_cap.nHydro = c(29.725,19.859), 
                          n = c(2766, 9563))
#--------------------------------------------


unique((pp_data_dummy2 %>% filter(capacity >= 30))$plant_1) %>% length
unique((pp_data_dummy2 %>% filter(capacity < 30))$plant_1) %>% length
```



```{r}
#--------------------------------------------
str(pp_data_dummy)
# table(pp_data_dummy$big_five)
# pp_data_dummy$big_five <- relevel(pp_data_dummy$big_five, ref = "1")
# DF$b = relevel(DF$b, ref=3)
# two different way to creat naive model.


#--------------------------------------------

# reg1 <- lm(complete ~ spr_festival*big_five + bf_covid*spr_festival+ big_five*bf_covid  +
#              area3
#            , data = pp_data_dummy) # +as.factor(yearmon)
#--------------------------------------------
pp_data$big_five <- as.factor(pp_data$big_five)
pp_data$city <- as.factor(pp_data$city)

pp_data %>% str



names(pp_data_dummy)
reg1 <- felm(complete ~ capacity + bf_covid|year + month + plant , data = pp_data)
# 
reg2 <- felm(complete ~ big_five*bf_covid*spr_festival|area3 + month, data = pp_data)
# coef1 <- summary(reg1)$coef
summary(reg1)
summary(reg2)

reg9 <- felm(complete ~ bf_covid|plant, pp_data)
summary(reg9)
mod_stargazer("reg1_naive.text", reg1, type = "text")
mod_stargazer("reg2_naive.text", reg2, type = "text")
```

#------------------------------------------

### 4.01 serious regs

```{r}
length(pp_data$plant %>% unique)
#--------------------------------------------
library(gt)
library(DataExplorer)
 
# two different way to creat naive model with interaction terms.
reg1 <- felm(complete ~ capacity+ bf_covid + year| month + plant, 
             data = pp_data)
(reg1 %>% summary)



reg2 <- felm(complete ~ 
               capacity +
               # city +
               year + 
               bf_covid + # delete this line would cause multi-insignificant. set fossil as baseline.
               bf_covid:type_of_p|
               plant + month|0,
               # year + area3 + plant, 
             data = pp_data)
(reg2 %>% summary)

mod_stargazer("../report/reg_1.text", reg1, type = "text", align = T, style = "aer")
mod_stargazer("../report/reg_2.text", reg2, type = "text", align = T, style = "aer")
#--------------------------------------------
pp_data$bf_covid <- as.factor(pp_data$bf_covid)
pp_data %>% str
reg_3 <- felm(complete ~ 
                    capacity +
                    year +
                    # city +
                    # factor(big_five) +
                    # bf_covid + 
                    # bf_covid:big_five + 
                    big_five:bf_covid:type_of_p - 1|
                    # plant + month|
                    0 , data = pp_data)
            # omit=c("big_five0:spr_festival1","big_five1:bf_covid1"))
#--------------------------------------------
(reg_3 %>% summary)$coef
mod_stargazer("../report/reg_3.text", reg_3, type = "text", align = T, style = "aer")

```


#### 4.1 monthly fixed effect
```{r}
# reg_covid_month <- felm(complete ~ big_five + big_five + 
#                     big_five*Hydro + big_five*wind + 
#                     big_five*`Fossil.fuel` + big_five*photovoltaic|area3 + yearmonth, data = pp_data)
# reg_covid_month %>% stg
```

#--------------------------------------------

### 4.2 covid on different levels/





#--------------------------------------------


### 5. Prediction

```{r}
# library(trelliscopejs)
library(caret)
library(ranger)
library(fastDummies)
library(neuralnet)#library(neuralnet)
library(plm)
library(gbm)
library(gamlr)
library(kernlab)
library(glmnet)
library(e1071)
library(nnet)



myControl <- trainControl(
  method = "cv", 
  number = 10,
)
```

#--------------------------------------------

### 5.1 monthly mean prediction
```{r}
# pp_data_before <- pp_data %>% filter(year != 20)
# pp_data_after <- pp_data %>% filter(year == 20)
```


<!-- ```{r monthly} -->
<!-- samplesize = 0.75 * nrow(pp_data_before) -->
<!-- set.seed(123) -->
<!-- index = sample(nrow(pp_data_before), size = samplesize) -->

<!-- # creating training and test set -->
<!-- pp_train = pp_data_before[index,] -->
<!-- pp_test = pp_data_before[-index,] -->
<!-- ``` -->
#--------------------------------------------

### 5.2 area3 mean prediction 

```{r area3}
# pp_data_test %>% names
# pp_data_before <- pp_data_test %>% filter(year != 20)
pp_data_before <- pp_data_test %>% filter(year != 20)
pp_data_after <- pp_data_test %>% filter(year == 20)
# samplesize = 0.75 * nrow(pp_data_before)
# set.seed(123)
# index = sample(nrow(pp_data_before), size = samplesize)

# creating training and test set
pp_train = pp_data_before[index,]
pp_test = pp_data_before[-index,]
names(pp_test)[20] <- "fossilfuel"
```

```{r nn}
pp_train <- pp_train[,-(1:5)]
names(pp_train)[15] <- "fossilfuel"

# pp_data_before <- model.matrix(~. -plant - plant_1 - parent_company - generated_el - time - op_time, 
#           data = pp_data_before)
# str(pp_data_before)


# type(pp_data_before[,1])

# for (i in 4:19){
#   if(is.numeric(pp_data_before[,i]) == T){
#     pp_data_before[,i] = pp_data_before[,i] %>% as.factor()
#   }
# }

pp_train %>% names
pp_data_before2 <- pp_train[,!names(pp_train) %in% c("plant", "parent_company", "yearmonth", "type_of_p", "plant_1", "area")]

# pp_data_before2 <- fastDummies::dummy_cols(pp_data_before2, select_columns = c("plant_1", "type_of_p"))
# pp_data_before2 <- pp_data_before2[,!names(pp_data_before2) %in% c("plant_1", "type_of_p")]




# pp_data_before2$complete <- pp_data_before2$complete %>% as.numeric()
# pp_data_before2$capacity <- pp_data_before2$capacity %>% as.numeric()

max = apply(pp_data_before2[,c(1:4, 7)], 2, max)
min = apply(pp_data_before2[,c(1:4, 7)], 2, min)
scaled = as.data.frame(scale(pp_data_before2[,c(1:4, 7)], center = min, scale = max - min))

pp_data_before2 <- cbind(scaled, pp_data_before2)
pp_data_before2 <- pp_data_before2[,-c(4, 6,7,8,9,12)]


# m <- model.matrix( 
#   ~ .-1, 
#   data = pp_data_before2 
# )

# 
# pp_data_before23 <- pp_data_before23[,1:10]
# 
# pp_data_before23 = pp_data_before2 %>% as.matrix()

# neuralnet(f, 
#           data = m, hidden = c(235), algorithm = "backprop", linear.output=T, learningrate = 0.01)
n <- names(m %>% data.frame)

f <- as.formula(paste("complete ~", paste(n[!n %in% c("complete")], collapse = " + ")))

f
n
#--------------

# nn <- neuralnet(f, 
          # data = m, hidden = c(235, 12), algorithm = "backprop", linear.output = T, learningrate = 0.00001)


# c((nn$data %>% names), pp_test %>% names)
predict_testNN = compute(nn, pp_test[,-2])
predict_testNN = (predict_testNN$net.result * (max(pp_data_before$complete) - min(pp_data_before$complete))) + min(pp_data_before$complete)
# plot(nn)
# pp_test <- pp_test[ , names(pp_test) %in% n]
```

```{r}
plot(pp_test$complete, predict_testNN, col='blue', pch=16, ylab = "predicted rating NN", xlab = "real rating")

abline(0,1)

# Calculate Root Mean Square Error (RMSE)
RMSE.NN = (sum((pp_test$complete - predict_testNN)^2) / nrow(pp_test)) ^ 0.5
RMSE.NN



pr.nn <- compute(nn,test_[,1:13])
pr.nn_ <- pr.nn$net.result*(max(data$medv)-min(data$medv))+min(data$medv)
test.r <- (test_$medv)*(max(data$medv)-min(data$medv))+min(data$medv)
MSE.nn <- sum((test.r - pr.nn_)^2)/nrow(test_)



```


#------------------------------------------

### 5.22 eliminate diffs among bf_af_covid


```{r}
pp_data_before <- pp_data_test %>% filter(year != 20 | (year == 20 & month == 1))


pp_data_after <- pp_data_test %>% filter(year == 20 & month != 1)
setdiff(pp_data_before$plant, pp_data_after$plant)
setdiff(pp_data_after$plant, pp_data_before$plant)


diffs <- pp_data_after$plant[which(!pp_data_after$plant %in% pp_data_before$plant)] %>% unique
diffs

# pp_data_after$parent_company[which(!pp_data_after$parent_company %in% pp_data_before$parent_company)] %>% unique
#--------------------------------------------
pp_data_before[pp_data_before$plant %in% setdiff(pp_data_before$plant, pp_data_after$plant),]$complete %>% sum / pp_data_before$complete %>% sum
#--------------------------------------------


pp_data_after <- pp_data_after[!pp_data_after$plant %in% diffs,]

pp_data_before3 <- pp_data_before[pp_data_after$plant %in% pp_data_before$plant,]
#------ 好像没什么必要.直接tm用前面的电厂名字不就行了么

#------------------------------------------
#scale data 


max = apply(pp_data_before3[,c(7,8)], 2, max)
min = apply(pp_data_before3[,c(7,8)], 2, min)
pp_data_before3 %>% names
scaled = as.data.frame(scale(pp_data_before3[,c(7,8)], center = min, scale = max - min))

pp_data_before3 <- pp_data_before3[,-c(1:10, 14,22,23, 24)]
# pp_data_before3 <- pp_data_before3[,-c(13,14)]
pp_data_before3 <- cbind(scaled, pp_data_before3)
names(pp_data_before3)[11:12] = c("fossilfuel", "bigfive")

# pp_data_before3 <- pp_data_before3[,-c(5,6)]
#------------------------------------------
#scale data 

max2 = apply(pp_data_after[,c(7,8)], 2, max)
min2 = apply(pp_data_after[,c(7,8)], 2, min)
scaled2 = as.data.frame(scale(pp_data_after[,c(7,8)], center = min2, scale = max2 - min2))

pp_data_after <- pp_data_after[,-c(1:10, 14,22,23, 24)]

pp_data_after <- cbind(scaled2, pp_data_after)
names(pp_data_after)[11:12] = c("fossilfuel", "bigfive")

```

```{r}
#--------------------------------------------
# py translations
pp_data_before3$parent_company <- pp_data_before3$parent_company %>% py(sep = "", dic = pydic(method = 'toneless', dic = "pinyin2"))
pp_data_before3$area <- pp_data_before3$area %>% py(sep = "", dic = pydic(method = 'toneless', dic = "pinyin2"))
#------------------------------------------

pp_data_after$parent_company <- pp_data_after$parent_company %>% py(sep = "", dic = pydic(method = 'toneless', dic = "pinyin2"))
pp_data_after$area <- pp_data_after$area %>% py(sep = "", dic = pydic(method = 'toneless', dic = "pinyin2"))

```
#------------------------------------------

```{r}
pp_data_bf_dummy <- fastDummies::dummy_cols(pp_data_before3, select_columns = c("month", "year", "parent_company", "area", "plant_1" ))
# "month"
pp_data_bf_dummy <- pp_data_bf_dummy[,!names(pp_data_bf_dummy) %in% c("parent_company", "year", "month", "area", "plant_1" )]

# year cannot be a dummy cause u'll have to predict it
#------------------------------------------
pp_data_after_dummy <- fastDummies::dummy_cols(pp_data_after, select_columns = c("month","year","parent_company", "area", "plant_1" ))

pp_data_after_dummy <- pp_data_after_dummy[,!names(pp_data_after_dummy) %in% c("month","year","parent_company", "area", "plant_1" )]
 
```


#------------------------------------------
# real prediction

```{r}
samplesize = 0.75 * nrow(pp_data_bf_dummy)
set.seed(123)
index = sample(nrow(pp_data_bf_dummy), size = samplesize)
pp_train = pp_data_bf_dummy[index,]
pp_test = pp_data_bf_dummy[-index,]
#------------------------------------------
```

```{r}
names(pp_train) <- make.names(names(pp_train))
names(pp_test) <- make.names(names(pp_test))
n <- names(pp_train %>% data.frame)
# view(n)
f <- as.formula(paste("complete ~", paste(n[!n %in% c("complete")], collapse = " + ")))

# which(str(pp_train) == factor)
#--------------
which(is.factor(pp_test[,-2]  ))


nn <- neuralnet(f, 
          data = pp_train, 
          hidden = c(6), 
          algorithm = "backprop", 
          linear.output = T, 
          learningrate = 0.0001,
          stepmax=1e+07,
          threshold = .2)

# which(is.numeric(pp_test[,-2][,1]) == T)
# pp_test2 <- pp_test[,-2] 
# pp_test2[,1] <- pp_test2[,1] %>% as.numeric()
# c((nn$data %>% names), pp_test %>% names)

# sapply(pp_test2, class)
#------------------------------------------
#------------------------------------------
 # pp_test[,-2]

#------------------------------------------
# for (i in 1:2541){#
#   for (j in 1:696){#
#     if (is.numeric(pp_test2[i,j]) == T){
#       pp_test2[i,j] <- as.numeric(pp_test2[i,j])
#     }
#     # else{
#     #   print("no")
#     # }
#   }
# }

#------------------------------------------
plot(nn)

# c((nn$data %>% names), pp_test %>% names)
predict_testNN = compute(nn, pp_test[,-2])

predict_testNN = (predict_testNN$net.result * (max(pp_data_before$complete) - min(pp_data_before$complete))) + min(pp_data_before$complete)
# plot(nn)
# pp_test <- pp_test[ , names(pp_test) %in% n]
pp_test2 <- pp_test
pp_test2$complete2 <- (pp_test$complete * (max(pp_data_before$complete) - min(pp_data_before$complete))) + min(pp_data_before$complete)
```

```{r}

# plot(pp_test$complete, predict_testNN, col='blue', pch=16, ylab = "predicted complete NN", xlab = "real complete")


#------------------------------------------
## RMSE test data
plot(pp_test2$complete2, predict_testNN, col='blue', pch=16, ylab = "predicted complete NN", xlab = "real complete")


abline(0,1)
# Calculate Root Mean Square Error (RMSE)

# pp_data_before4 <- pp_data_before[pp_data_after$plant %in% pp_data_before$plant,]

# RMSE.NN = (sum((pp_test$complete - predict_testNN)^2) / nrow(pp_test)) ^ 0.5

RMSE.NN = (sum((pp_test$complete2 - predict_testNN)^2) / nrow(pp_test)) ^ 0.5

RMSE.NN


```

```{r}
# modify pp_data_after_dummy, for extra names of plants. not sure why appeared?

b = setdiff(names(pp_data_after_dummy), names(pp_test))

a = which(pp_data_after_dummy[,setdiff(names(pp_data_after_dummy), names(pp_test))] == 1)


pp_data_after_dummy <- pp_data_after_dummy[-a, ]
pp_data_after_dummy <- pp_data_after_dummy[ , !names(pp_data_after_dummy) %in% b]
# pp_data_after_dummy[140,] %>% view
#--------------------------------------------
# modift pp_data_after
# mmmodify <- gsub("parent_company_", "", names(pp_data_after_dummy))
# mmmmodift <- gsub("plant_1_", "", names(pp_data_after_dummy))
# which(pp_data_after$plant_1 == mmmmodift)
# which(pp_data_after$parent_company == mmmodify)
pp_data_after2 <- pp_data_after[-which(pp_data_after$plant_1 == mmmmodift), ]
pp_data_after2 <- pp_data_after2[-which(pp_data_after$parent_company == mmmodify), ]
# 
# 
# setdiff(pp_data_after2$plant_1, gsub("plant_1_", "", names(pp_data_after_dummy)))
# # pp_data_after = pp_data_after[-which(pp_data_after$plant_1 == gsub("plant_1_","", b[-1])),]
# pp_data_after = pp_data_after[-which(pp_data_after$parent_company == gsub("parent_company_","", b[1])),]
#------------------------------------------
# adding plants exists before but disappear by 2020 
add.dataframe= {}
## #prediciton in 2020
# 我的year 为什么是 dummy啊 反思了
setdiff(names(pp_data_after_dummy), names(pp_test))
c = setdiff(names(pp_test), names(pp_data_after_dummy))
add.dataframe = data.frame(c) %>% transpose()
names(add.dataframe) = add.dataframe[1,]
add.dataframe[1:1791, ] = as.numeric(0)
pp_data_after_dummy = cbind(pp_data_after_dummy, add.dataframe)
pp_data_after_dummy = lapply(pp_data_after_dummy, as.numeric) %>% data.frame()
# abort 
#--------------------------------------------
names(pp_data_after_dummy) <- make.names(names(pp_data_after_dummy))

#--------------------------------------------
```

```{r}
grep("month", names(pp_data_after_dummy), value =T)
# sum(pp_data_after_dummy$month_10)    0 

pp_data_after_dummy2 <- pp_data_after_dummy
pp_data_after_dummy2

#--------------------------------------------
# this sheet is not working. 
# pp_data_bf_dummy$year 
pp_19_20_after <- pp_data_bf_dummy %>% filter(year_17 == 1)
pp_19_20_after$year_17 = 0 %>% as.numeric()
pp_19_20_after$year_20 = 1 %>% as.numeric()
```

```{r}
predict_after = compute(nn, pp_data_after_dummy[,-2])
predict_afternn = (predict_after$net.result * (max(pp_data_before$complete) - min(pp_data_before$complete))) + min(pp_data_before$complete)
# plot(nn)
# pp_test <- pp_test[ , names(pp_test) %in% n]

#--------------------------------------------
# mimic calculating using 19 year data
predict_19_20_after = compute(nn, pp_19_20_after[,-2])
predict_19_20_afternn = (predict_19_20_after$net.result * (max(pp_data_before$complete) - min(pp_data_before$complete))) + min(pp_data_before$complete)

data_19 <- pp_data %>% filter(year == 17)
data_19 <- cbind(predict_19_20_afternn, data_19)
dfpp <- data_19 %>% group_by(month) %>% summarise(sum(predict_19_20_afternn))


dfpp %>% names()
gpt(dfpp) + aes(x = month, y = `sum(predict_19_20_afternn)`) +
  geom_line()
```




```{r}
scheme <- {} %>% data.frame()

# dim(pp_data_after_dummy)
for (i in 1:dim(pp_data_after_dummy)[1]){
  for (j in 1:dim(pp_data_after_dummy)[2]){
    if (j <= 2){
      scheme[i,j] = pp_data_after_dummy[i,j]
    }
    else if (j >= 8 & j <= 12){
      if (pp_data_after_dummy[i,j] == 1){
        scheme[i,j] = names(pp_data_after_dummy)[j]
      }
      else{
        scheme[i,j] = NA
      }
    }
  }
}

scheme %>% na.omit
```


```{r}
pp_data_after2 <- pp_data_after2[-which(pp_data_after2$complete == pp_data_after2$complete %>% min)[1], ]

pp_data_afternn <- data.frame(pred_af = predict_afternn)
pp_af_predicted <- cbind(pp_data_afternn, pp_data_after2)

pp_af_predicted %>% group_by(month) %>% summarise(sum(pred_af))

pp_data_afternn %>% sum
(pp_data_test %>% filter(year == 19))$complete %>% sum
```

### 5.23 or directly use the plants in bf_covid time.

```{r}
pp_data_after2 <- pp_data_before[,c("year", "month")]
```




## Linear Regression

```{r message=FALSE, warning=FALSE}
# From previous step
# which(is.na(pp_train))
# names(pp_train)

tuneGrid <- data.frame(
    alpha = seq(0, 1, length = 5),
    lambda = seq(0, 1, length = 20)
)

# Fit random forest: model
lr_model <- train(
  complete ~ .,
  data = pp_train, 
  method = "nnet",
  preProcess = "range",
  tuneLength = 2,
  trace = FALSE,
  maxit = 100)

 

plot(lr_model)

# TrainData <- iris[,1:4]
# TrainClasses <- iris[,5]
# nnetFit <- train(TrainData, TrainClasses,
#                  method = "nnet",
#                  preProcess = "range", 
#                  tuneLength = 2,
#                  trace = FALSE,
#                  maxit = 100)


model <- train(y ~ x1+x2, dat, method='nnet', linout=TRUE, trace = FALSE)
```

```{r}
# lr_model$bestTune
# lr_model$finalModel ## dont run
# pp_test <- pp_test %>% filter(pp_test$plant_1 != c("chongfudianchang", "kunpengguangfu", "shangpoguangfu", "wuxiangyongxinguangfu"))
# which(pp_test$plant_1 == "chongfudianchang")

# mod2$xlevels[["y"]] <- union(mod2$xlevels[["y"]], levels(test$y))

pred_mean.com <- predict(lr_model, newdata = pp_test)
pp_test <- cbind(pp_test, pred_mean.com)
```


```{r}

p11 <- ggplot(pp_test, aes(x = pp_test$pred_mean.com, y=pp_test$mean.com)) + 
  geom_point(alpha=0.8, col ="grey") + 
  # scale_x_continuous(limits=c(0,100)) +
  # scale_y_continuous(limits=c(0,100)) +
  geom_abline(intercept=0,slope=1) +
  geom_smooth(se=0,method = "lm") +
  coord_fixed(1) +
  ggtitle("LR")
p11

LR_RMSE <- sqrt(sum((pp_test$pred_mean.com-pp_test$mean.com)^2)/nrow(pp_test))
LR_RMSE
```


```{r, warning = F}
pred_mean.com2 <- predict(lr_model, newdata = pp_data_after)
pp_test2 <- cbind(pp_data_after, pred_mean.com2)

dfp_plus <- pp_test2 %>% group_by(month) %>% summarise(sum(pred_mean.com2)) 
dfp_plus$year = "20pre"
# pp_test2 %>% group_by(month) %>% summarise(sum(mean.com.area3)) %>% plot

names(dfp_plus)[2] = "sum(complete)"

dfp2 <- rbind(dfp,dfp_plus)
```

```{r, warning = F}
p12 <- ggplot(pp_test2, aes(x = month, y=)) + 
  geom_point(alpha=0.8, col ="grey") + 
  # scale_x_continuous(limits=c(0,100)) +
  # scale_y_continuous(limits=c(0,100)) +
  # geom_abline(intercept=0,slope=1) +
  # geom_smooth(se=0,method = "lm") +
  # coord_fixed(1) +
  ggtitle("LR")
p12

LR_RMSE <- sqrt(sum((pp_test$pred_mean.com-pp_test$mean.com)^2)/nrow(pp_test))
LR_RMSE
```


```{r}
for (i in 1:2541){#
  for (j in 1:696){#
    if (is.numeric(pp_test2[i,j]) == T){
      pp_test2[i,j] <- as.numeric(pp_test2[i,j])
    }
    # else{
    #   print("no")
    # }
  }
  }
```

